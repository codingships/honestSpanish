---
import { useTranslations, getLocalizedPath } from '../i18n/utils';
import { createSupabaseServerClient } from '../lib/supabase-server';
import { Image } from 'astro:assets';
import PricingSection from './PricingSection';
import heroImage from '../assets/hero.png';
import madridAtmosphere from '../assets/madrid_atmosphere.png';
import noiseTexture from '../assets/noise_texture.png';
import avatarAlejandro from '../assets/avatar_alejandro.png';
import avatarAlin from '../assets/avatar_alin.png';
import iconEsencial from '../assets/icon-esencial.png';
import iconIntensivo from '../assets/icon-intensivo.png';
import iconPremium from '../assets/icon-premium.png';
import LeadCaptureForm from './LeadCaptureForm';

interface Props {
  lang: 'es' | 'en' | 'ru';
}

const { lang } = Astro.props;
const t = useTranslations(lang);

// Fetch packages from Supabase
const supabase = createSupabaseServerClient(Astro);
const { data: packages, error: packagesError } = await supabase
    .from('packages')
    .select('id, name, display_name, price_monthly, sessions_per_month, stripe_price_1m, stripe_price_3m, stripe_price_6m')
    .eq('is_active', true)
    .order('price_monthly', { ascending: true });

// Debug: Log what we got from Supabase
console.log('Packages fetched:', packages?.length || 0, 'items');
if (packagesError) {
    console.error('Packages fetch error:', packagesError);
}

// Check if user is logged in
const { data: { user } } = await supabase.auth.getUser();
const isLoggedIn = !!user;

// Data structure helper for complex arrays 
const problemsStatements = t('problems.statements') as unknown as string[];
const methodColumns = t('method.columns') as unknown as any[];
const progressMilestones = t('progress.milestones') as unknown as any[];
const teamMembers = t('team.members') as unknown as any[];
const faqItems = t('faq.items') as unknown as any[];
const pricingTranslations = t('pricing') as unknown as any;
const leadCaptureTranslations = t('leadCapture') as unknown as any;

const s = {
    bg: 'bg-[#E0F7FA]',
    text: 'text-[#006064]',
    accent: 'bg-[#006064]',
    accentText: 'text-white',
    border: 'border-[#006064]',
    secondaryBg: 'bg-white',
    button: 'bg-[#006064] text-white hover:bg-[#004d40]',
};

// Language switcher link builder
const supportedLanguages = ['es', 'en', 'ru'];
const getLangLink = (targetLang) => `/${targetLang}`;

---

<div class={`min-h-screen ${s.bg} ${s.text} transition-colors duration-300 font-sans selection:bg-black selection:text-white`}>
    
    {/* Navbar */}
    <nav class={`h-16 border-b-2 ${s.border} flex justify-between items-center px-4 md:px-8 sticky top-0 z-50 ${s.bg}`}>
        <div class="font-display text-lg md:text-xl tracking-tighter truncate mr-2 w-full md:w-auto">{t('nav.brand')}</div>

        {/* Desktop Navigation Links (Hidden on Mobile) */}
        <div class="hidden md:flex gap-6 items-center">
            <a href="#metodo" class="font-mono text-xs uppercase tracking-wide hover:opacity-70 transition-opacity">{t('nav.method')}</a>
            <a href="#progreso" class="font-mono text-xs uppercase tracking-wide hover:opacity-70 transition-opacity">{t('nav.progress')}</a>
            <a href="#planes" class="font-mono text-xs uppercase tracking-wide hover:opacity-70 transition-opacity">{t('nav.plans')}</a>
            <a href="#equipo" class="font-mono text-xs uppercase tracking-wide hover:opacity-70 transition-opacity">{t('nav.team')}</a>
            <a href="#faq" class="font-mono text-xs uppercase tracking-wide hover:opacity-70 transition-opacity">{t('nav.faq')}</a>
            <a href={getLocalizedPath('/blog', lang)} class="font-mono text-xs uppercase tracking-wide hover:opacity-70 transition-opacity">{t('nav.blog')}</a>
        </div>

        {/* Desktop Actions (Hidden on Mobile) */}
        <div class="hidden md:flex flex-row items-center gap-4">
            {/* Language Switcher */}
            <div class="flex items-center gap-1 font-mono text-xs font-bold">
                {supportedLanguages.map((lng) => (
                    <a
                        href={getLangLink(lng)}
                        class={`px-2 py-1 border ${s.border} uppercase transition-colors inline-block no-underline ${lang === lng ? `${s.accent} ${s.accentText}` : 'opacity-70 hover:opacity-100'}`}
                    >
                        {lng}
                    </a>
                ))}
            </div>

            <a href={`/${lang}/login`} class={`px-4 py-1 text-xs font-bold uppercase border ${s.border} hover:opacity-50 transition-opacity`}>
                {t('nav.login')}
            </a>
        </div>

        {/* Hamburger Icon (Mobile Only) */}
        <button id="mobile-menu-btn" aria-label="Menu" class="md:hidden flex flex-col justify-center items-center w-10 h-10 border-2 border-[#006064] bg-[#E0F7FA] active:bg-[#006064] active:text-[#E0F7FA] transition-colors focus:outline-none z-50 relative group">
            <span class="block w-5 h-0.5 bg-current mb-1 transition-transform origin-center group-[.is-open]:rotate-45 group-[.is-open]:translate-y-[6px]"></span>
            <span class="block w-5 h-0.5 bg-current mb-1 transition-opacity group-[.is-open]:opacity-0"></span>
            <span class="block w-5 h-0.5 bg-current transition-transform origin-center group-[.is-open]:-rotate-45 group-[.is-open]:-translate-y-[6px]"></span>
        </button>
    </nav>

    {/* Mobile Overlay Menu */}
    <div id="mobile-overlay" class="fixed inset-0 bg-[#006064] z-40 transform translate-x-full transition-transform duration-300 ease-in-out md:hidden flex flex-col">
        {/* Menu Content */}
        <div class="flex flex-col flex-1 p-8 mt-16 overflow-y-auto">
            <div class="flex flex-col gap-6 text-2xl font-display text-white mb-12">
                <a href="#metodo" class="mobile-link hover:text-[#E0F7FA]/70">{t('nav.method')}</a>
                <a href="#progreso" class="mobile-link hover:text-[#E0F7FA]/70">{t('nav.progress')}</a>
                <a href="#planes" class="mobile-link hover:text-[#E0F7FA]/70">{t('nav.plans')}</a>
                <a href="#equipo" class="mobile-link hover:text-[#E0F7FA]/70">{t('nav.team')}</a>
                <a href="#faq" class="mobile-link hover:text-[#E0F7FA]/70">{t('nav.faq')}</a>
                <a href={getLocalizedPath('/blog', lang)} class="mobile-link hover:text-[#E0F7FA]/70">{t('nav.blog')}</a>
            </div>

            <div class="mt-auto flex flex-col gap-6">
                {/* Mobile Language Switcher */}
                <div class="flex justify-center gap-2 font-mono text-sm font-bold w-full">
                    {supportedLanguages.map((lng) => (
                        <a
                            href={getLangLink(lng)}
                            class={`flex-1 py-3 text-center border-2 border-[#E0F7FA] uppercase transition-colors no-underline ${lang === lng ? 'bg-[#E0F7FA] text-[#006064]' : 'text-[#E0F7FA] hover:bg-[#E0F7FA]/10'}`}
                        >
                            {lng}
                        </a>
                    ))}
                </div>
                
                {/* Mobile Login Button */}
                <a href={`/${lang}/login`} class="w-full py-4 text-center font-bold uppercase tracking-widest border-2 border-[#E0F7FA] bg-[#E0F7FA] text-[#006064] active:bg-transparent active:text-[#E0F7FA] transition-colors">
                    {t('nav.login')}
                </a>
            </div>
        </div>
    </div>

    {/* Hero */}
    <header class={`border-b-2 ${s.border} relative z-20 bg-[#E0F7FA]`}>
        <div class="grid grid-cols-1 lg:grid-cols-12 h-auto lg:min-h-[calc(100vh-112px)]">
            <div class={`lg:col-span-7 p-6 md:p-12 flex flex-col justify-start border-b-2 lg:border-b-0 lg:border-r-2 ${s.border}`}>
                <div>
                    <h1 class="font-display text-[12vw] md:text-[9vw] lg:text-[7.5vw] leading-[1.1] lg:leading-[1.1] tracking-tighter break-words">
                        {t('hero.headline1')} <br />
                        <span class="italic">{t('hero.headline2')}</span> <br />
                        {t('hero.headline3')}
                    </h1>
                </div>
                <div class="mt-20 max-w-md">
                    <p class="font-mono text-sm md:text-base uppercase tracking-wide mb-6">{t('hero.manifesto')}</p>
                    <p class="text-lg md:text-xl font-bold leading-tight">{t('hero.subtitle')}</p>
                </div>
            </div>
            <div class="lg:col-span-5 flex flex-col h-auto lg:h-full overflow-hidden min-h-0">
                <div class={`h-48 md:h-64 lg:h-[40vh] min-h-0 border-b-2 ${s.border} relative overflow-hidden group`}>
                    <Image 
                        src={heroImage} 
                        alt="Estudiante practicando español" 
                        class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-700" 
                        loading="eager"
                        width={800}
                        height={600}
                    />
                </div>
                <div class={`flex-1 ${s.secondaryBg} p-8 lg:p-12 flex flex-col justify-center items-center text-center`}>
                    <h2 class="font-display text-3xl lg:text-4xl mb-4 lg:mb-6">{t('hero.ready')}</h2>
                    <a
                        href="#contacto"
                        class={`inline-block ${s.button} px-6 lg:px-8 py-3 lg:py-4 text-base lg:text-lg font-bold border-2 ${s.border} shadow-[4px_4px_0px_0px_currentColor] hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all uppercase tracking-wider`}
                    >
                        {t('hero.cta')}
                    </a>
                </div>
            </div>
        </div>
    </header>

    {/* Ticker - Full Width */}
    <div class={`relative z-10 w-full border-b-2 ${s.border} overflow-hidden py-3 ${s.accent} ${s.accentText}`}>
        <div class="animate-marquee whitespace-nowrap font-mono font-bold text-sm md:text-base uppercase tracking-widest">
            {/* Simple repetition for ticker effect */}
            {Array(8).fill(t('ticker')).join('')}
        </div>
    </div>

    {/* El Problema */}
    <section
        class="bg-white py-24 px-6 border-b-2 border-[#006064]"
        style={`background-image: url(${noiseTexture.src}); background-size: 200px;`}
    >
        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-12">
            {/* Left Column */}
            <div class="lg:col-span-2">
                <h2 class="font-display text-4xl lg:text-5xl text-[#006064] mb-4" style={{ lineHeight: '1.55' }}>{t('problems.headline')}</h2>
                <p class="font-sans text-xl text-[#006064]/70 font-medium">{t('problems.subtext')}</p>
            </div>

            {/* Right Column (Pain Points) */}
            <div class="lg:col-span-3 space-y-8">
                {problemsStatements.map((statement, index) => (
                    <div class="relative pl-2">
                        <span class="absolute -top-6 -left-4 font-display text-8xl text-[#006064]/10 select-none pointer-events-none">
                            0{index + 1}
                        </span>
                        <p class="relative z-10 font-sans text-lg md:text-xl text-[#006064] font-medium leading-relaxed">
                            {statement}
                        </p>
                    </div>
                ))}
            </div>
        </div>
    </section>

    {/* El Método */}
    <section id="metodo" class="bg-[#006064] py-24 px-6 border-b-2 border-[#006064]">
        <div class="max-w-6xl mx-auto">
            {/* Header */}
            <div class="mb-16">
                <h2 class="font-display text-4xl lg:text-5xl text-white mb-6 leading-tight">{t('method.headline')}</h2>

                <div class="max-w-md mb-12">
                    <p class="text-[#E0F7FA]/70 font-mono text-sm md:text-base uppercase tracking-wide mb-4">{t('method.manifesto')}</p>
                    <p class="font-sans text-lg md:text-xl text-white font-bold leading-tight">{t('method.closing')}</p>
                </div>

                <p class="font-sans text-xl text-[#E0F7FA] font-medium max-w-2xl">{t('method.subtitle')}</p>
            </div>

            {/* 3 Columns */}
            <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                {methodColumns.map((col) => (
                    <div class="relative">
                        <span class="font-display text-6xl text-white/20 mb-4 block select-none">
                            {col.number}
                        </span>
                        <h3 class="font-display text-xl text-white mb-4 uppercase tracking-wide">{col.title}</h3>
                        <p class="font-sans text-base text-[#E0F7FA] leading-relaxed">
                            {col.description}
                        </p>
                    </div>
                ))}
            </div>

            <div class="mt-24 pt-12 border-t border-white/20">
            </div>
        </div>
    </section>

    {/* Atmosphere Break */}
    <div class={`w-full h-64 md:h-96 overflow-hidden border-b-2 ${s.border} relative`}>
        <Image 
            src={madridAtmosphere} 
            alt="Vista atmosférica" 
            class="w-full h-full object-cover grayscale" 
            width={1200}
        />
        <div class="absolute inset-0 bg-[#006064]/20 mix-blend-multiply"></div>
    </div>

    {/* Tu Progreso */}
    <section id="progreso" class="bg-[#E0F7FA] py-24 px-6 border-b-2 border-[#006064]">
        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-12">
            <div class="lg:col-span-2">
                <h2 class="font-display text-4xl lg:text-5xl text-[#006064] mb-4 leading-tight">{t('progress.headline')}</h2>
                <div class="max-w-md mb-8">
                    <p class="text-[#006064]/70 font-mono text-sm md:text-base uppercase tracking-wide mb-4">{t('progress.manifesto')}</p>
                    <p class="font-sans text-lg md:text-xl text-[#006064] font-bold leading-tight">{t('progress.closing')}</p>
                </div>
                <h3 class="font-sans text-xl text-[#006064]/80 mb-6 font-medium">{t('progress.subheadline')}</h3>
                <p class="font-sans text-base text-[#006064]/70 mb-12 leading-relaxed">
                    {t('progress.paragraph')}
                </p>
            </div>

            <div class="lg:col-span-3 pl-4 md:pl-0">
                <div class="space-y-12 border-l-2 border-[#006064]/30 pl-8 md:pl-12 relative">
                    {progressMilestones.map((milestone) => (
                        <div class="relative">
                            <div class="absolute -left-[39px] md:-left-[55px] top-2 w-4 h-4 rounded-full bg-[#006064] border-2 border-[#E0F7FA]"></div>
                            <h4 class="font-display text-xl text-[#006064] mb-2">{milestone.months}</h4>
                            <p class="font-sans text-base text-[#006064]/70 leading-relaxed">
                                {milestone.description}
                            </p>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    </section>

    {/* Pricing */}
    <PricingSection 
        client:load
        packages={packages || []}
        lang={lang}
        isLoggedIn={isLoggedIn}
        translations={pricingTranslations}
    />

    {/* Quiénes Somos (Team) */}
    <section id="equipo" class="bg-white py-24 px-6 border-b-2 border-[#006064]">
        <div class="max-w-6xl mx-auto">
            <div class="text-center mb-16">
                <h2 class="font-display text-4xl lg:text-5xl text-[#006064] mb-8">{t('team.headline')}</h2>

                <div class="max-w-md mx-auto mb-8">
                    <p class="text-[#006064]/70 font-mono text-sm md:text-base uppercase tracking-wide mb-4">{t('team.manifesto')}</p>
                    <p class="font-sans text-lg md:text-xl text-[#006064] font-bold leading-tight">{t('team.closing')}</p>
                </div>

                <p class="font-sans text-xl text-[#006064]/70 max-w-2xl mx-auto">{t('team.subtitle')}</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                {teamMembers.map((member, index) => (
                    <div class="flex flex-col">
                        <div class="aspect-square bg-gray-200 rounded-lg mb-4 w-full overflow-hidden border-2 border-[#006064]">
                                <Image
                                    src={index === 0 ? avatarAlejandro : avatarAlin}
                                    alt={member.name}
                                    class="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-500"
                                    width={400}
                                />
                        </div>
                        <h3 class="font-display text-2xl text-[#006064] mb-1">{member.name}</h3>
                        <p class="font-sans text-sm uppercase tracking-wide text-[#006064]/50 mb-4">{member.role}</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            {member.languages.map((langString) => (
                                <span class="bg-[#006064]/10 text-[#006064] text-xs px-2 py-1 rounded font-bold">
                                    {langString}
                                </span>
                            ))}
                        </div>
                        <p class="font-sans text-base text-[#006064]/70">
                            {member.bio}
                        </p>
                    </div>
                ))}
            </div>
        </div>
    </section>

    {/* FAQ */}
    <section id="faq" class="bg-[#E0F7FA] py-24 px-6 border-b-2 border-[#006064]">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-16">
                <h2 class="font-display text-4xl lg:text-5xl text-[#006064]">{t('faq.headline')}</h2>
            </div>

            <div class="space-y-4">
                {faqItems.map((item, index) => (
                    <div class="border-b border-[#006064]/20">
                        <button
                            data-faq-button={index}
                            class="w-full flex justify-between items-center py-6 text-left focus:outline-none group"
                            aria-expanded="false"
                        >
                            <span class="font-sans font-semibold text-lg text-[#006064] pr-8">{item.question}</span>
                            <span class="faq-icon text-[#006064] text-2xl font-bold transition-transform duration-300">
                                +
                            </span>
                        </button>
                        <div
                            id={`faq-content-${index}`}
                            class="faq-content overflow-hidden transition-all duration-300 max-h-0 opacity-0"
                        >
                            <p class="font-sans text-base text-[#006064]/80 leading-relaxed pb-6">
                                {item.answer}
                            </p>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </section>

    {/* Lead Capture Section */}
    <section id="contacto" class="py-24 px-6 border-t-2 border-[#006064] bg-[#E0F7FA]">
        <div class="max-w-4xl mx-auto">
             <LeadCaptureForm 
                client:visible
                lang={lang}
                translations={leadCaptureTranslations}
            />
        </div>
    </section>

    {/* Footer */}
    <footer class={`${s.accent} ${s.accentText} py-24 px-6 border-t-2 ${s.border}`}>
        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-12">
            <div>
                <h2 class="font-display text-[12vw] md:text-[8vw] leading-[0.8] tracking-tighter">{t('footer.cta1')}</h2>
                <h2 class="font-display text-[12vw] md:text-[8vw] leading-[0.8] tracking-tighter opacity-50">{t('footer.cta2')}</h2>
            </div>
            <div class="flex flex-col justify-end items-start md:items-end">
                <div class="font-mono text-sm uppercase tracking-widest mb-8 text-left md:text-right">
                    {t('footer.address')}<br />{t('footer.city')}<br />{t('footer.email')}
                </div>
                <div class="flex gap-4 mb-4">
                    <a href={`/${lang}/legal`} class="font-mono text-xs uppercase opacity-60 hover:opacity-100 transition-opacity">
                        {t('legal.title')}
                    </a>
                </div>
                <p class="font-sans text-xs opacity-60">&copy; {new Date().getFullYear()} {t('footer.copyright')}</p>
            </div>
        </div>
    </footer>
</div>

<script>
    document.querySelectorAll('[data-faq-button]').forEach(button => {
        button.addEventListener('click', () => {
            const index = button.getAttribute('data-faq-button');
            const content = document.getElementById(`faq-content-${index}`);
            const icon = button.querySelector('.faq-icon');
            
            const isExpanded = button.getAttribute('aria-expanded') === 'true';
            
            // Toggle current
            if (isExpanded) {
                button.setAttribute('aria-expanded', 'false');
                content.style.maxHeight = '0';
                content.style.opacity = '0';
                icon.style.transform = 'rotate(0deg)';
                icon.innerText = '+';
            } else {
                // Close others if desired (optional, replicating accordion behavior usually implies one open or multiple)
                // Current React implementation allowed closing, didn't strictly force one open but usually typically does. 
                // Let's implement standard toggle behavior matching the React code: setOpenFaq(openFaq === index ? null : index);
                // This means only one can be open at a time.
                
                document.querySelectorAll('[data-faq-button]').forEach(otherBtn => {
                    if (otherBtn !== button) {
                        const otherIndex = otherBtn.getAttribute('data-faq-button');
                        const otherContent = document.getElementById(`faq-content-${otherIndex}`);
                        const otherIcon = otherBtn.querySelector('.faq-icon');
                        
                        otherBtn.setAttribute('aria-expanded', 'false');
                        otherContent.style.maxHeight = '0';
                        otherContent.style.opacity = '0';
                        otherIcon.style.transform = 'rotate(0deg)';
                        otherIcon.innerText = '+';
                    }
                });

                button.setAttribute('aria-expanded', 'true');
                content.style.maxHeight = '24rem'; // Arbitrary large height or scrollHeight
                content.style.opacity = '1';
                icon.style.transform = 'rotate(45deg)';
                // icon.innerText is '+' rotated 45deg looks like X, no need to change text technically if using rotation
            }
        });
    });

    // Mobile Menu Logic
    const menuBtn = document.getElementById('mobile-menu-btn');
    const overlay = document.getElementById('mobile-overlay');
    const mobileLinks = document.querySelectorAll('.mobile-link');
    let isMenuOpen = false;

    const toggleMenu = () => {
        isMenuOpen = !isMenuOpen;
        if (isMenuOpen) {
            overlay?.classList.remove('translate-x-full');
            overlay?.classList.add('translate-x-0');
            menuBtn?.classList.add('is-open', 'bg-transparent', 'text-white', 'border-transparent');
            menuBtn?.classList.remove('bg-[#E0F7FA]', 'text-[#006064]', 'border-[#006064]');
            document.body.style.overflow = 'hidden';
        } else {
            overlay?.classList.add('translate-x-full');
            overlay?.classList.remove('translate-x-0');
            menuBtn?.classList.remove('is-open', 'bg-transparent', 'text-white', 'border-transparent');
            menuBtn?.classList.add('bg-[#E0F7FA]', 'text-[#006064]', 'border-[#006064]');
            document.body.style.overflow = '';
        }
    };

    menuBtn?.addEventListener('click', toggleMenu);

    mobileLinks.forEach(link => {
        link.addEventListener('click', () => {
            if (isMenuOpen) toggleMenu();
        });
    });
</script>
