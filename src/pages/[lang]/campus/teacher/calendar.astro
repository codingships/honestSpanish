---
import CampusLayout from '../../../../layouts/CampusLayout.astro';
import { useTranslations } from '../../../../i18n/utils';
import { createSupabaseServerClient } from '../../../../lib/supabase-server';
import TeacherCalendar from '../../../../components/calendar/TeacherCalendar';
import AvailabilityManager from '../../../../components/calendar/AvailabilityManager';

export async function getStaticPaths() {
    return [
        { params: { lang: 'es' } },
        { params: { lang: 'en' } },
        { params: { lang: 'ru' } }
    ];
}

const { lang } = Astro.params as { lang: 'es' | 'en' | 'ru' };
const t = useTranslations(lang);

const supabase = createSupabaseServerClient(Astro);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
    return Astro.redirect(`/${lang}/login`);
}

const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

if (!profile || (profile.role !== 'teacher' && profile.role !== 'admin')) {
    return Astro.redirect(`/${lang}/campus`);
}

// Obtener disponibilidad actual
const { data: availability } = await supabase
    .from('teacher_availability')
    .select('*')
    .eq('teacher_id', user.id)
    .eq('is_active', true)
    .order('day_of_week')
    .order('start_time');

// Obtener sesiones de la semana actual y siguiente
const today = new Date();
const startOfWeek = new Date(today);
startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Lunes
startOfWeek.setHours(0, 0, 0, 0);

const endOfNextWeek = new Date(startOfWeek);
endOfNextWeek.setDate(startOfWeek.getDate() + 13); // 2 semanas
endOfNextWeek.setHours(23, 59, 59, 999);

const { data: sessions } = await supabase
    .from('sessions')
    .select(`
        *,
        student:profiles!sessions_student_id_fkey(id, full_name, email)
    `)
    .eq('teacher_id', user.id)
    .gte('scheduled_at', startOfWeek.toISOString())
    .lte('scheduled_at', endOfNextWeek.toISOString())
    .neq('status', 'cancelled')
    .order('scheduled_at');

// Obtener estudiantes asignados para el modal de programar clase
const { data: assignedStudents } = await supabase
    .from('student_teachers')
    .select(`
        profiles!student_teachers_student_id_fkey (
            id,
            full_name,
            email
        )
    `)
    .eq('teacher_id', user.id);

const students = (assignedStudents || []).map((s: any) => s.profiles).filter(Boolean);

// Nombres de d√≠as en el idioma actual
const dayNames: Record<string, string[]> = {
    es: ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'],
    en: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
    ru: ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞']
};

// Traducciones para componentes
const calendarTranslations = {
    title: t('campus.teacher.calendar.title'),
    availability: t('campus.teacher.calendar.availability'),
    schedule: t('campus.teacher.calendar.schedule'),
    noSessions: t('campus.teacher.calendar.noSessions'),
    today: t('campus.teacher.calendar.today'),
    week: t('campus.teacher.calendar.week'),
    addSlot: t('campus.teacher.calendar.addSlot'),
    removeSlot: t('campus.teacher.calendar.removeSlot'),
    from: t('campus.teacher.calendar.from'),
    to: t('campus.teacher.calendar.to'),
    save: t('campus.teacher.calendar.save'),
    cancel: t('common.cancel'),
    scheduleClass: t('campus.teacher.calendar.scheduleClass'),
    selectStudent: t('campus.teacher.calendar.selectStudent'),
    selectDate: t('campus.teacher.calendar.selectDate'),
    selectTime: t('campus.teacher.calendar.selectTime'),
    duration: t('campus.teacher.calendar.duration'),
    minutes: t('campus.teacher.calendar.minutes'),
    confirm: t('campus.teacher.calendar.confirm'),
    completed: t('campus.teacher.calendar.completed'),
    scheduled: t('campus.teacher.calendar.scheduled'),
    cancelled: t('campus.teacher.calendar.cancelled'),
    noShow: t('campus.teacher.calendar.noShow'),
    markComplete: t('campus.teacher.calendar.markComplete'),
    markNoShow: t('campus.teacher.calendar.markNoShow'),
    cancelSession: t('campus.teacher.calendar.cancelSession'),
    addNotes: t('campus.teacher.calendar.addNotes'),
    dayNames: dayNames[lang] || dayNames['es'],
    continue: t('campus.teacher.calendar.continue'),
    back: t('campus.teacher.calendar.back'),
    loading: t('campus.teacher.calendar.loading'),
    noSlotsDate: t('campus.teacher.calendar.noSlotsDate'),
    setupAvailability: t('campus.teacher.calendar.setupAvailability'),
    summary: t('campus.teacher.calendar.summary'),
    studentLabel: t('campus.teacher.calendar.studentLabel'),
    dateLabel: t('campus.teacher.calendar.dateLabel'),
    timeLabel: t('campus.teacher.calendar.timeLabel'),
    meetLinkOptional: t('campus.teacher.calendar.meetLinkOptional'),
    errorLoadingSlots: t('campus.teacher.calendar.errorLoadingSlots'),
    errorScheduling: t('campus.teacher.calendar.errorScheduling'),
};
---

<CampusLayout 
    title={t('campus.teacher.calendar.title')}
    user={{ ...user, ...profile }}
    lang={lang}
>
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
        <div>
            <h1 class="font-display text-3xl text-[#006064] uppercase">{t('campus.teacher.calendar.title')}</h1>
            <p class="text-sm text-[#006064]/60 font-mono mt-1">
                {t('campus.teacher.calendar.subtitle')}
            </p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex border-b-2 border-[#006064] mb-6">
        <button 
            id="tab-calendar"
            class="px-6 py-3 font-bold text-sm uppercase border-b-4 border-[#006064] text-[#006064] bg-white -mb-[2px]"
        >
            üìÖ {t('campus.teacher.calendar.schedule')}
        </button>
        <button 
            id="tab-availability"
            class="px-6 py-3 font-bold text-sm uppercase text-[#006064]/60 hover:text-[#006064] transition-colors"
        >
            ‚è∞ {t('campus.teacher.calendar.availability')}
        </button>
    </div>

    <!-- Calendar View -->
    <div id="view-calendar">
        <TeacherCalendar 
            client:load
            sessions={sessions || []}
            students={students}
            teacherId={user.id}
            lang={lang}
            translations={calendarTranslations}
        />
    </div>

    <!-- Availability View -->
    <div id="view-availability" class="hidden">
        <AvailabilityManager 
            client:load
            initialAvailability={availability || []}
            teacherId={user.id}
            lang={lang}
            translations={calendarTranslations}
        />
    </div>
</CampusLayout>

<script>
    const tabCalendar = document.getElementById('tab-calendar');
    const tabAvailability = document.getElementById('tab-availability');
    const viewCalendar = document.getElementById('view-calendar');
    const viewAvailability = document.getElementById('view-availability');

    function setActiveTab(tab: 'calendar' | 'availability') {
        if (tab === 'calendar') {
            tabCalendar?.classList.add('border-b-4', 'border-[#006064]', 'bg-white', '-mb-[2px]');
            tabCalendar?.classList.remove('text-[#006064]/60');
            tabAvailability?.classList.remove('border-b-4', 'border-[#006064]', 'bg-white', '-mb-[2px]');
            tabAvailability?.classList.add('text-[#006064]/60');
            viewCalendar?.classList.remove('hidden');
            viewAvailability?.classList.add('hidden');
        } else {
            tabAvailability?.classList.add('border-b-4', 'border-[#006064]', 'bg-white', '-mb-[2px]');
            tabAvailability?.classList.remove('text-[#006064]/60');
            tabCalendar?.classList.remove('border-b-4', 'border-[#006064]', 'bg-white', '-mb-[2px]');
            tabCalendar?.classList.add('text-[#006064]/60');
            viewAvailability?.classList.remove('hidden');
            viewCalendar?.classList.add('hidden');
        }
    }

    tabCalendar?.addEventListener('click', () => setActiveTab('calendar'));
    tabAvailability?.addEventListener('click', () => setActiveTab('availability'));
</script>
